---
title: "vig1_overview"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vig1_overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# The problem that package `rvecs` tries to solve

Many modern statistical methods produce output result in a set of random draws
$$
  \theta_1, \theta_2, \dots, \theta_S
$$
from a distribution $p(\theta)$. Distribution $p(\theta)$ could, for instance, be outcomes from a simulation study, or a posterior distribution from a Bayesian analysis. Quantity $\theta$ could be a scalar, but it could also be a vector with thousands of elements. 

Statistics calculated over the random draws can be used to to characterise the unknown quantity $\theta$. The median value $q_{0.5}^{(\theta)}$ obtained from draws $\theta_1, \theta_2, \dots, \theta_S$, for instance, can be used as a point estimate of $\theta$, and the quantiles $q_{0.025}^{(\theta)}$ and $q_{0.975}^{(\theta)}$ can be used to construct a 95\% credible interval.

An enormously useful feature of random draws is that the same approach can be used to make inferences about functions of the unknown quantity. If $f$ is some function, then to make inferences about $f(\theta)$, we

1. apply $f$ to each draw of $\theta$, obtaining, $f(\theta_1 ), f(\theta_2), \dots, f(\theta_S)$, and then
2. summarise the $f(\theta_1 ), f(\theta_2), \dots, f(\theta_S)$ using statistics such as quantiles.

Say, for instance, that $\theta = (\theta^{\text{F}}, \theta^{\text{M}})$ was a vector describing divorce rates for females and males, and that we were interested in the ratio between female and male rates. Function $f$ would then be $f(x,y) = x/y$. To obtain a point estimate and 95\% credible interval for the ratio, we would 

1. calculate ratios, $\theta_1^{\text{F}}/\theta_1^{\text{M}}, \theta_2^{\text{F}}/\theta_2^{\text{M}}, \dots, \theta_S^{\text{F}}/\theta_S^{\text{M}}$,
2. calculate  median $q_{0.5}^{(\theta^\text{F}/\theta^{\text{M}})}$, and quantiles $q_{0.025}^{(\theta^\text{F}/\theta^{\text{M}})}$ and $q_{0.975}^{(\theta^\text{F}/\theta^{\text{M}})}$.

In computing terms, this procedure is a simple type of map-reduce style calculation. In step 1, transformations are applied, in parallel, to multiple quantities. In step 2, the outcomes are combined into an overall result.




- Want to make that easy
    - Store output
    - Parallel
    - Reduce


# Examples

```{r}
library(rvec)
library(dplyr, warn.conflicts = FALSE)
library(tidyr)
library(ggplot2)
```



## Toy example

```{r}
m <- matrix(1:6, nrow = 3)
x <- rvec(m)
x
```

```{r}
x - 1
```



```{r}
x > 3
```

```{r}
x[c(1, 3)]
```



```{r}
y <- rvec(matrix(c(0.5, 2), nrow = 1))
y
```

```{r}
x * y^2
```

```{r}
draws_mean(x)
```



## Divorce rates

```{r}
divorce
```

```{r}
divorce_rv <- divorce %>%
  collapse_to_rvec(draw = "sim", value = rate)
divorce_rv
```


```{r}
divorce_rv %>%
  group_by(time, sex) %>%
  summarise(tdr = 5 * sum(rate))
```


```{r}
divorce_rv %>%
  group_by(time, sex) %>%
  summarise(tdr = 5 * sum(rate)) %>%
  mutate(draws_quantile(tdr))
```

```{r}
divorce_rv %>%
  pivot_wider(names_from = sex, values_from = rate) %>%
  mutate(ratio = Female / Male)
```


```{r, fig.width = 5, fig.height = 5}
divorce_rv %>%
  pivot_wider(names_from = sex, values_from = rate) %>%
  mutate(ratio = Female / Male) %>%
  mutate(draws_quantile(ratio)) %>%
  ggplot(aes(x = age, 
             ymin = `ratio_2.5%`, 
             y = `ratio_50%`,
             ymax = `ratio_97.5%`)) +
  facet_wrap(vars(time), ncol = 1) +
  geom_pointrange(fatten = 1)
```



# Working with rvecs

## Creation

## Manipulation

## Mathematics

## Summarising
   
  
# Design

- vctrs
- matrixStats



# Other packages

## rv

## coda, posterior

## ggdist

?other









